{
  "case_id": "logic_bug_20",
  "category": "logic_bug",
  "difficulty": "hard",
  "expected_detection": true,
  "bug_description": "タイミング攻撃に脆弱。== による文字列比較は一致しない位置で早期終了するため、比較時間からトークンを1文字ずつ推測できる。また、find_by でトークンを直接検索しているため、DBインデックスを使った攻撃も可能。",
  "bug_location": "impl.rb:15-16",
  "correct_implementation": "api_token = ApiToken.find_by(user_id: expected_user_id)\nreturn nil unless api_token && ActiveSupport::SecurityUtils.secure_compare(api_token.token, provided_token)",
  "tags": ["timing_attack", "security", "cryptography"],
  "notes": "セキュリティに敏感な文字列比較では secure_compare を使用。通常の比較演算子は処理時間が入力に依存するため危険。"
}
