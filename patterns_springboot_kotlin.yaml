# AI Code Review Benchmark - Spring Boot (Kotlin) Bug Pattern Definitions
# 98 patterns (85 bugs + 13 false positives) for Spring Boot e-commerce order processing
# Version: 2.0
# Framework: Spring Boot 3.2+, Kotlin 1.9+

# =============================================================================
# Price Calculation (6 patterns) - Spec Alignment
# =============================================================================

- id: CALC_001
  category: calculation
  axis: spec_alignment
  name: discount_rate_direction
  plan: "Apply 10% discount for members"
  bug_description: "Discount rate direction wrong, becomes 90% off"
  correct: "total.multiply(BigDecimal(\"0.9\"))"
  incorrect: "total.multiply(BigDecimal(\"0.1\"))"
  severity: critical
  difficulty: easy
  tags: [calculation, discount, member]

- id: CALC_002
  category: calculation
  axis: spec_alignment
  name: tax_calculation_order
  plan: "Calculate total with 10% tax after discount"
  bug_description: "Tax calculation order wrong - applying tax before discount yields different amount"
  correct: "subtotal.subtract(discount).multiply(BigDecimal(\"1.1\"))"
  incorrect: "subtotal.multiply(BigDecimal(\"1.1\")).subtract(discount)"
  severity: high
  difficulty: medium
  tags: [calculation, tax, discount]

- id: CALC_003
  category: calculation
  axis: spec_alignment
  name: floating_point_currency
  plan: "Calculate price with decimal precision"
  bug_description: "Using Double instead of BigDecimal for monetary calculations"
  correct: "BigDecimal(\"0.1\") + BigDecimal(\"0.2\")"
  incorrect: "0.1 + 0.2"
  severity: high
  difficulty: medium
  tags: [calculation, currency, precision]

- id: CALC_004
  category: calculation
  axis: spec_alignment
  name: inconsistent_rounding
  plan: "Calculate order total with consistent rounding"
  bug_description: "Inconsistent rounding - round per item then sum vs sum then round yields different results"
  correct: "items.map { it.subtotal }.reduce(BigDecimal::add).setScale(2, RoundingMode.HALF_UP)"
  incorrect: "items.map { it.subtotal.setScale(2, RoundingMode.HALF_UP) }.reduce(BigDecimal::add)"
  severity: medium
  difficulty: medium
  tags: [calculation, rounding]

- id: CALC_005
  category: calculation
  axis: spec_alignment
  name: hardcoded_tax_rate
  plan: "Apply current tax rate (10%)"
  bug_description: "Hardcoded old tax rate - still using 8% instead of 10%"
  correct: "subtotal.multiply(taxRateRepository.findCurrentRate())"
  incorrect: "subtotal.multiply(BigDecimal(\"0.08\"))"
  severity: high
  difficulty: easy
  tags: [calculation, tax, hardcode]

- id: CALC_006
  category: calculation
  axis: spec_alignment
  name: free_shipping_boundary
  plan: "Free shipping for orders of 5000 yen or more"
  bug_description: "Boundary condition error - >= 5000 vs > 5000"
  correct: "if (total >= BigDecimal(\"5000\")) BigDecimal.ZERO else shippingFee"
  incorrect: "if (total > BigDecimal(\"5000\")) BigDecimal.ZERO else shippingFee"
  severity: medium
  difficulty: easy
  tags: [calculation, shipping, boundary]

- id: CALC_007
  category: calculation
  axis: spec_alignment
  name: points_calculation_order
  plan: "Award points based on payment amount after discount"
  bug_description: "Points calculated on pre-discount amount instead of post-discount"
  correct: "total.subtract(discount).multiply(pointRate)"
  incorrect: "total.multiply(pointRate)"
  severity: medium
  difficulty: medium
  tags: [calculation, points, discount]

- id: CALC_008
  category: calculation
  axis: spec_alignment
  name: coupon_stacking_logic
  plan: "Apply single coupon per order"
  bug_description: "Coupon stacking allowed - multiple coupons can be applied"
  correct: "if (order.couponApplied) throw CouponAlreadyAppliedException(); applyCoupon(coupon)"
  incorrect: "applyCoupon(coupon) // no check for existing coupon"
  severity: high
  difficulty: medium
  tags: [calculation, coupon, validation]

- id: CALC_009
  category: calculation
  axis: spec_alignment
  name: minimum_order_amount
  plan: "Minimum order amount is 1000 yen after discounts"
  bug_description: "Minimum check on pre-discount amount instead of post-discount"
  correct: "subtotal.subtract(discount) >= BigDecimal(\"1000\")"
  incorrect: "subtotal >= BigDecimal(\"1000\")"
  severity: medium
  difficulty: medium
  tags: [calculation, validation, minimum]

- id: CALC_010
  category: calculation
  axis: spec_alignment
  name: quantity_overflow
  plan: "Calculate total for bulk orders"
  bug_description: "Integer overflow on unit_price * quantity for large orders"
  correct: "BigDecimal(unitPrice).multiply(BigDecimal(quantity))"
  incorrect: "unitPrice * quantity // Int overflow"
  severity: critical
  difficulty: hard
  tags: [calculation, overflow, bulk]

# =============================================================================
# User & Authorization (7 patterns) - Spec Alignment
# =============================================================================

- id: AUTH_001
  category: authorization
  axis: spec_alignment
  name: access_other_user_order
  plan: "Users can only view their own orders"
  bug_description: "IDOR vulnerability - can access other user's order by changing ID"
  correct: "orderRepository.findByIdAndUserId(orderId, currentUser.id)"
  incorrect: "orderRepository.findById(orderId)"
  severity: critical
  difficulty: easy
  tags: [authorization, idor, security]

- id: AUTH_002
  category: authorization
  axis: spec_alignment
  name: manipulate_other_cart
  plan: "Users can only modify their own cart"
  bug_description: "Can manipulate other user's cart by specifying cart_id"
  correct: "cartRepository.findByUserId(currentUser.id)"
  incorrect: "cartRepository.findById(cartId)"
  severity: critical
  difficulty: easy
  tags: [authorization, cart, security]

- id: AUTH_003
  category: authorization
  axis: spec_alignment
  name: preauthorize_condition_wrong
  plan: "Only order owner or admin can cancel order"
  bug_description: "@PreAuthorize condition uses OR instead of proper ownership check"
  correct: "@PreAuthorize(\"@orderService.isOwner(#orderId, principal) or hasRole('ADMIN')\")"
  incorrect: "@PreAuthorize(\"hasRole('USER') or hasRole('ADMIN')\")"
  severity: critical
  difficulty: medium
  tags: [authorization, preauthorize, security]

- id: AUTH_004
  category: authorization
  axis: spec_alignment
  name: admin_permission_missing
  plan: "Only admins can modify product prices"
  bug_description: "Regular users can change prices - admin check missing"
  correct: "@PreAuthorize(\"hasRole('ADMIN')\")"
  incorrect: "// no permission check"
  severity: critical
  difficulty: easy
  tags: [authorization, admin, permission]

- id: AUTH_005
  category: authorization
  axis: spec_alignment
  name: guest_member_pricing
  plan: "Member pricing only for logged-in members"
  bug_description: "Guest users getting member pricing - membership check hole"
  correct: "if (currentUser?.isMember == true) memberPrice else regularPrice"
  incorrect: "memberPrice // no membership check"
  severity: high
  difficulty: medium
  tags: [authorization, membership, pricing]

- id: AUTH_006
  category: authorization
  axis: spec_alignment
  name: access_other_points
  plan: "Users can only view their own points"
  bug_description: "Can access other user's points via API"
  correct: "pointsRepository.findByUserId(currentUser.id)"
  incorrect: "pointsRepository.findByUserId(userId) // from request param"
  severity: high
  difficulty: easy
  tags: [authorization, points, api]

- id: AUTH_007
  category: authorization
  axis: spec_alignment
  name: coupon_owner_missing
  plan: "Users can only use their own coupons"
  bug_description: "Can use another user's coupon code"
  correct: "couponRepository.findByCodeAndUserId(code, currentUser.id)"
  incorrect: "couponRepository.findByCode(code) // no owner check"
  severity: high
  difficulty: medium
  tags: [authorization, coupon, ownership]

# =============================================================================
# State Management (7 patterns) - Spec Alignment
# =============================================================================

- id: STATE_001
  category: state
  axis: spec_alignment
  name: invalid_state_transition
  plan: "Order can only be cancelled from PENDING or CONFIRMED state"
  bug_description: "Allows cancellation from any state including SHIPPED"
  correct: "if (order.status == PENDING || order.status == CONFIRMED) { order.cancel() }"
  incorrect: "order.cancel()"
  severity: high
  difficulty: medium
  tags: [state, validation, order]

- id: STATE_002
  category: state
  axis: spec_alignment
  name: state_update_conflict
  plan: "Prevent concurrent state updates"
  bug_description: "Race condition - no optimistic locking on state update"
  correct: "@Version var version: Long = 0"
  incorrect: "// no version field"
  severity: high
  difficulty: hard
  tags: [state, concurrency, locking]

- id: STATE_003
  category: state
  axis: spec_alignment
  name: check_then_act_race
  plan: "Atomic check and update for stock reservation"
  bug_description: "Check-then-act race condition between stock check and reservation"
  correct: "stockRepository.decrementIfAvailable(productId, quantity)"
  incorrect: "if (stock.quantity >= quantity) { stock.quantity = stock.quantity - quantity }"
  severity: critical
  difficulty: hard
  tags: [state, concurrency, stock]

- id: STATE_004
  category: state
  axis: spec_alignment
  name: enum_comparison_wrong
  plan: "Check if order is in completed states"
  bug_description: "Using string comparison instead of enum comparison"
  correct: "order.status in completedStatuses"
  incorrect: "completedStatuses.any { it.name == order.status.name }"
  severity: medium
  difficulty: medium
  tags: [state, enum, comparison]

- id: STATE_005
  category: state
  axis: spec_alignment
  name: partial_cancel_integrity
  plan: "Update total correctly on partial cancellation"
  bug_description: "Total amount wrong after partial item cancellation"
  correct: "order.recalculateTotal() after partialCancel(item)"
  incorrect: "partialCancel(item) // no total recalculation"
  severity: high
  difficulty: medium
  tags: [state, cancellation, calculation]

- id: STATE_006
  category: state
  axis: spec_alignment
  name: refund_status_missing
  plan: "Update payment status after refund"
  bug_description: "Payment shows unpaid despite refund completion"
  correct: "payment.status = PaymentStatus.REFUNDED after processRefund()"
  incorrect: "processRefund() // no status update"
  severity: high
  difficulty: easy
  tags: [state, refund, status]

- id: STATE_007
  category: state
  axis: spec_alignment
  name: delivery_status_regression
  plan: "Delivery status can only move forward"
  bug_description: "Delivered can regress to shipping status"
  correct: "if (currentStatus.ordinal >= newStatus.ordinal) throw InvalidTransitionException()"
  incorrect: "delivery.status = newStatus // allows regression"
  severity: medium
  difficulty: medium
  tags: [state, delivery, regression]

# =============================================================================
# Time & Date (8 patterns) - Spec Alignment
# =============================================================================

- id: TIME_001
  category: time
  axis: spec_alignment
  name: timezone_not_considered
  plan: "Check if campaign is active based on Japan time"
  bug_description: "Using system default timezone instead of specified timezone"
  correct: "LocalDateTime.now(ZoneId.of(\"Asia/Tokyo\"))"
  incorrect: "LocalDateTime.now()"
  severity: high
  difficulty: medium
  tags: [time, timezone, campaign]

- id: TIME_002
  category: time
  axis: spec_alignment
  name: date_boundary_error
  plan: "Campaign valid until end of specified date"
  bug_description: "End date comparison excludes the last day"
  correct: "!now.isAfter(campaign.endDate.atTime(23, 59, 59))"
  incorrect: "now.isBefore(campaign.endDate.atStartOfDay())"
  severity: medium
  difficulty: medium
  tags: [time, boundary, campaign]

- id: TIME_003
  category: time
  axis: spec_alignment
  name: campaign_period_check
  plan: "Apply campaign discount only during valid period"
  bug_description: "Only checking start date, not end date"
  correct: "now.isAfter(campaign.startDate) && now.isBefore(campaign.endDate)"
  incorrect: "now.isAfter(campaign.startDate)"
  severity: high
  difficulty: easy
  tags: [time, campaign, validation]

- id: TIME_004
  category: time
  axis: spec_alignment
  name: date_only_comparison
  plan: "Compare dates ignoring time component"
  bug_description: "Time truncation causes next-day treatment"
  correct: "deliveryDate.toLocalDate() == targetDate.toLocalDate()"
  incorrect: "deliveryDate == targetDate // includes time"
  severity: medium
  difficulty: medium
  tags: [time, date, comparison]

- id: TIME_005
  category: time
  axis: spec_alignment
  name: month_end_processing
  plan: "Handle month-end dates correctly"
  bug_description: "Invalid date error - February 30 doesn't exist"
  correct: "date.plusMonths(1).withDayOfMonth(minOf(day, date.plusMonths(1).lengthOfMonth()))"
  incorrect: "LocalDate.of(year, month + 1, day) // may not exist"
  severity: high
  difficulty: hard
  tags: [time, month_end, validation]

- id: TIME_006
  category: time
  axis: spec_alignment
  name: year_crossing
  plan: "Handle year boundary correctly"
  bug_description: "Year crossing logic error - 12/31 to 1/1 fails"
  correct: "date.plusDays(1)"
  incorrect: "LocalDate.of(year, month, day + 1) // fails on Dec 31"
  severity: high
  difficulty: hard
  tags: [time, year_end, boundary]

- id: TIME_007
  category: time
  axis: spec_alignment
  name: business_day_calculation
  plan: "Calculate delivery in business days"
  bug_description: "Weekends and holidays not excluded from business days"
  correct: "addBusinessDays(date, 3) // excludes weekends/holidays"
  incorrect: "date.plusDays(3) // includes weekends"
  severity: medium
  difficulty: medium
  tags: [time, business_day, holiday]

- id: TIME_008
  category: time
  axis: spec_alignment
  name: past_delivery_date
  plan: "Delivery date must be in the future"
  bug_description: "Past delivery dates accepted"
  correct: "@field:Future var deliveryDate: LocalDate"
  incorrect: "var deliveryDate: LocalDate // no future validation"
  severity: medium
  difficulty: easy
  tags: [time, validation, future]

# =============================================================================
# Inventory Management (8 patterns) - Spec Alignment
# =============================================================================

- id: STOCK_001
  category: stock
  axis: spec_alignment
  name: stock_reservation_race
  plan: "Reserve stock atomically"
  bug_description: "Race condition between stock check and decrement"
  correct: "@Modifying @Query(\"UPDATE Stock s SET s.quantity = s.quantity - :qty WHERE s.productId = :productId AND s.quantity >= :qty\")"
  incorrect: "if (stock.quantity >= qty) stock.quantity = stock.quantity - qty"
  severity: critical
  difficulty: hard
  tags: [stock, concurrency, atomic]

- id: STOCK_002
  category: stock
  axis: spec_alignment
  name: negative_stock_allowed
  plan: "Stock quantity must not go negative"
  bug_description: "No validation prevents negative stock"
  correct: "@field:Min(0) var quantity: Int"
  incorrect: "var quantity: Int"
  severity: high
  difficulty: easy
  tags: [stock, validation, constraint]

- id: STOCK_003
  category: stock
  axis: spec_alignment
  name: cart_stock_divergence
  plan: "Validate stock availability at checkout"
  bug_description: "Cart quantity not revalidated - stock may deplete while cart abandoned"
  correct: "validateStockAvailability(cart.items) before checkout"
  incorrect: "// skip stock validation at checkout"
  severity: high
  difficulty: medium
  tags: [stock, cart, validation]

- id: STOCK_004
  category: stock
  axis: spec_alignment
  name: reserved_actual_confusion
  plan: "Track reserved and available stock separately"
  bug_description: "Reserved stock counted as available - double counting"
  correct: "available = totalStock - reservedStock"
  incorrect: "available = totalStock // ignores reserved"
  severity: critical
  difficulty: medium
  tags: [stock, reservation, counting]

- id: STOCK_005
  category: stock
  axis: spec_alignment
  name: zero_quantity_order
  plan: "Validate item quantity is positive"
  bug_description: "Zero quantity orders allowed through validation gap"
  correct: "@field:Min(1) var quantity: Int"
  incorrect: "@field:Min(0) var quantity: Int // allows zero"
  severity: medium
  difficulty: easy
  tags: [stock, validation, quantity]

- id: STOCK_006
  category: stock
  axis: spec_alignment
  name: stock_restoration_overflow
  plan: "Prevent negative stock levels"
  bug_description: "Cancellation processing can drive stock beyond max capacity"
  correct: "stock = minOf(stock + cancelledQty, maxStock)"
  incorrect: "stock += cancelledQty // may exceed max"
  severity: high
  difficulty: medium
  tags: [stock, cancellation, overflow]

- id: STOCK_007
  category: stock
  axis: spec_alignment
  name: duplicate_stock_restoration
  plan: "Restore stock once per cancellation"
  bug_description: "Cancel spam increases stock - no idempotency check"
  correct: "if (order.stockRestored) return; restoreStock(); order.stockRestored = true"
  incorrect: "restoreStock() // no idempotency check"
  severity: critical
  difficulty: medium
  tags: [stock, cancellation, idempotency]

- id: STOCK_008
  category: stock
  axis: spec_alignment
  name: bundle_stock_calculation
  plan: "Bundle availability is minimum of component stocks"
  bug_description: "Bundle stock not calculated as minimum of components"
  correct: "components.minOfOrNull { it.stock } ?: 0"
  incorrect: "components.sumOf { it.stock } // wrong aggregation"
  severity: high
  difficulty: hard
  tags: [stock, bundle, calculation]

# =============================================================================
# Notification (6 patterns) - Spec Alignment
# =============================================================================

- id: NOTIFY_001
  category: notification
  axis: spec_alignment
  name: async_notification_failure
  plan: "Send order confirmation email asynchronously"
  bug_description: "Async email failure silently ignored - no error handling"
  correct: "@Async fun sendEmail(): CompletableFuture<Unit> { try { ... } catch (e: Exception) { logger.error(...); throw e } }"
  incorrect: "@Async fun sendEmail() { ... }"
  severity: medium
  difficulty: medium
  tags: [notification, async, error_handling]

- id: NOTIFY_002
  category: notification
  axis: spec_alignment
  name: async_error_swallowed
  plan: "Handle background job failures"
  bug_description: "Background job fails silently - user not notified"
  correct: "catch (e: Exception) { notifyAdmin(e); throw e }"
  incorrect: "catch (e: Exception) { logger.error(e.message) } // swallowed"
  severity: high
  difficulty: medium
  tags: [notification, async, error]

- id: NOTIFY_003
  category: notification
  axis: spec_alignment
  name: notification_timing
  plan: "Send confirmation after payment confirmed"
  bug_description: "Order complete email sent before payment confirmation"
  correct: "@TransactionalEventListener(phase = AFTER_COMMIT) fun sendConfirmation()"
  incorrect: "@EventListener fun sendConfirmation() // may run before commit"
  severity: high
  difficulty: medium
  tags: [notification, timing, order]

- id: NOTIFY_004
  category: notification
  axis: spec_alignment
  name: template_variable_nil
  plan: "Handle nil values in email templates"
  bug_description: "Template variable user.name is null causing error"
  correct: "user?.name ?: \"Valued Customer\""
  incorrect: "user.name // throws NPE if null"
  severity: medium
  difficulty: easy
  tags: [notification, template, null]

- id: NOTIFY_005
  category: notification
  axis: spec_alignment
  name: recipient_mixup
  plan: "Send email to correct recipient"
  bug_description: "Email sent to wrong user due to variable scope"
  correct: "emailService.send(order.user.email, template)"
  incorrect: "emailService.send(user.email, template) // wrong user variable"
  severity: critical
  difficulty: medium
  tags: [notification, recipient, privacy]

- id: NOTIFY_006
  category: notification
  axis: spec_alignment
  name: bulk_rate_limit
  plan: "Respect email provider rate limits"
  bug_description: "Mass email send gets blocked by rate limit"
  correct: "users.chunked(100).forEach { chunk -> delay(1000); sendBatch(chunk) }"
  incorrect: "users.forEach { sendEmail(it) } // no rate limiting"
  severity: medium
  difficulty: medium
  tags: [notification, bulk, rate_limit]

# =============================================================================
# Spring Boot Specific (17 patterns) - Implicit Knowledge
# =============================================================================

- id: SPRING_001
  category: spring
  axis: implicit_knowledge
  name: transactional_propagation_wrong
  plan: "Order and payment must be processed atomically"
  bug_description: "@Transactional propagation issue - nested service has REQUIRES_NEW causing partial commit"
  correct: "@Transactional(propagation = Propagation.REQUIRED)"
  incorrect: "@Transactional // nested call has REQUIRES_NEW"
  severity: critical
  difficulty: hard
  tags: [spring, transaction, propagation]

- id: SPRING_002
  category: spring
  axis: implicit_knowledge
  name: async_without_enable
  plan: "Process order asynchronously"
  bug_description: "@Async annotation ignored - @EnableAsync missing on configuration"
  correct: "@EnableAsync @Configuration class AsyncConfig"
  incorrect: "// @EnableAsync missing"
  severity: high
  difficulty: medium
  tags: [spring, async, configuration]

- id: SPRING_003
  category: spring
  axis: implicit_knowledge
  name: field_injection_testing
  plan: "Inject OrderService dependency"
  bug_description: "Field injection makes unit testing difficult - use constructor injection"
  correct: "@Service class OrderController(private val orderService: OrderService)"
  incorrect: "@Service class OrderController { @Autowired lateinit var orderService: OrderService }"
  severity: medium
  difficulty: easy
  tags: [spring, injection, testing]

- id: SPRING_004
  category: spring
  axis: implicit_knowledge
  name: missing_valid_annotation
  plan: "Validate request body"
  bug_description: "@Valid missing on @RequestBody - validation annotations ignored"
  correct: "fun create(@Valid @RequestBody request: OrderRequest): ResponseEntity<*>"
  incorrect: "fun create(@RequestBody request: OrderRequest): ResponseEntity<*>"
  severity: high
  difficulty: easy
  tags: [spring, validation, request]

- id: SPRING_005
  category: spring
  axis: implicit_knowledge
  name: exception_info_leak
  plan: "Handle exceptions gracefully"
  bug_description: "Exception message exposed to client - potential security info leak"
  correct: "ResponseEntity.badRequest().body(ErrorResponse(\"Invalid request\"))"
  incorrect: "ResponseEntity.badRequest().body(e.message)"
  severity: high
  difficulty: medium
  tags: [spring, security, exception]

- id: SPRING_006
  category: spring
  axis: implicit_knowledge
  name: circular_dependency
  plan: "OrderService depends on PaymentService"
  bug_description: "Circular dependency - OrderService -> PaymentService -> OrderService"
  correct: "Use @Lazy or refactor to break cycle"
  incorrect: "// OrderService and PaymentService inject each other"
  severity: high
  difficulty: hard
  tags: [spring, dependency, circular]

- id: SPRING_007
  category: spring
  axis: implicit_knowledge
  name: cacheable_key_missing
  plan: "Cache product by ID"
  bug_description: "@Cacheable without key - uses all parameters by default, causing cache misses"
  correct: "@Cacheable(value = [\"products\"], key = \"#productId\")"
  incorrect: "@Cacheable(\"products\")"
  severity: medium
  difficulty: medium
  tags: [spring, cache, configuration]

- id: SPRING_008
  category: spring
  axis: implicit_knowledge
  name: repository_query_not_used
  plan: "Find active orders efficiently"
  bug_description: "Reimplementing findByStatus everywhere instead of using existing repository query method"
  correct: "orderRepository.findByStatus(OrderStatus.ACTIVE)"
  incorrect: "orderRepository.findAll().filter { it.status == OrderStatus.ACTIVE }"
  severity: medium
  difficulty: easy
  tags: [spring, repository, dry]

- id: SPRING_009
  category: spring
  axis: implicit_knowledge
  name: enum_string_comparison
  plan: "Check order status"
  bug_description: "String literal comparison instead of enum constant comparison"
  correct: "order.status == OrderStatus.PENDING"
  incorrect: "order.status.name == \"PENDING\""
  severity: medium
  difficulty: easy
  tags: [spring, enum, type_safety]

- id: SPRING_010
  category: spring
  axis: implicit_knowledge
  name: event_listener_order
  plan: "Process order events in sequence"
  bug_description: "@EventListener order dependency not specified - listeners execute in undefined order"
  correct: "@Order(1) @EventListener fun handleEvent()"
  incorrect: "@EventListener fun handleEvent() // no @Order"
  severity: high
  difficulty: medium
  tags: [spring, event, order]

- id: SPRING_011
  category: spring
  axis: implicit_knowledge
  name: orphan_removal_missing
  plan: "Delete order with its items"
  bug_description: "orphanRemoval = false - child records orphaned when parent deleted"
  correct: "@OneToMany(mappedBy = \"order\", orphanRemoval = true, cascade = [CascadeType.ALL])"
  incorrect: "@OneToMany(mappedBy = \"order\") // no orphanRemoval"
  severity: high
  difficulty: medium
  tags: [spring, jpa, cascade]

- id: SPRING_012
  category: spring
  axis: implicit_knowledge
  name: async_outside_commit
  plan: "Send notification after order saved"
  bug_description: "@Async called inside transaction - notification sent before commit, may reference uncommitted data"
  correct: "@TransactionalEventListener(phase = TransactionPhase.AFTER_COMMIT)"
  incorrect: "@Async inside @Transactional method"
  severity: critical
  difficulty: hard
  tags: [spring, async, transaction]

- id: SPRING_013
  category: spring
  axis: implicit_knowledge
  name: dto_validation_missing
  plan: "Validate nested request objects"
  bug_description: "@Valid missing on nested DTO - validation annotations in nested object ignored"
  correct: "data class OrderRequest(@field:Valid val items: List<OrderItemRequest>)"
  incorrect: "data class OrderRequest(val items: List<OrderItemRequest>) // no @Valid"
  severity: high
  difficulty: easy
  tags: [spring, validation, dto]

- id: SPRING_014
  category: spring
  axis: implicit_knowledge
  name: save_or_update_race
  plan: "Find or create order record"
  bug_description: "Race condition between findById and save - duplicate records possible"
  correct: "Use @Lock(LockModeType.PESSIMISTIC_WRITE) or INSERT ... ON CONFLICT"
  incorrect: "findById(id) ?: save(newEntity) // no locking"
  severity: high
  difficulty: hard
  tags: [spring, concurrency, race_condition]

- id: SPRING_015
  category: spring
  axis: implicit_knowledge
  name: modifying_skips_listeners
  plan: "Archive orders and trigger audit"
  bug_description: "@Modifying bulk update skips @EntityListeners - audit callbacks not triggered"
  correct: "findAll then save each entity to trigger listeners"
  incorrect: "@Modifying @Query(\"UPDATE Order o SET o.status = :status\") // skips listeners"
  severity: high
  difficulty: medium
  tags: [spring, jpa, listeners]

- id: SPRING_016
  category: spring
  axis: implicit_knowledge
  name: projection_vs_entity
  plan: "Load only needed order fields for report"
  bug_description: "Loading full entity when only specific fields needed - wasted memory and bandwidth"
  correct: "Use interface projection or @Query with constructor expression"
  incorrect: "findAll().map { listOf(it.id, it.total) }"
  severity: medium
  difficulty: medium
  tags: [spring, jpa, projection]

- id: SPRING_017
  category: spring
  axis: implicit_knowledge
  name: entitygraph_fetch_strategy
  plan: "Load orders with items and products"
  bug_description: "Multiple eager fetches causing cartesian product - N*M records returned"
  correct: "Use @EntityGraph with subgraphs or multiple queries"
  incorrect: "@EntityGraph(attributePaths = [\"items\", \"items.product\", \"payments\"]) // cartesian product"
  severity: high
  difficulty: hard
  tags: [spring, jpa, entitygraph]

# =============================================================================
# False Positive (13 patterns)
# =============================================================================

- id: FP_001
  category: false_positive
  axis: false_positive
  name: correct_discount_calculation
  plan: "Apply 10% member discount correctly"
  bug_description: null
  correct: "total.multiply(BigDecimal(\"0.9\"))"
  incorrect: null
  severity: null
  difficulty: easy
  tags: [false_positive, calculation, baseline]
  misleading_points: "None - standard implementation"

- id: FP_002
  category: false_positive
  axis: false_positive
  name: correct_transactional_usage
  plan: "Proper transactional boundary"
  bug_description: null
  correct: "@Transactional with proper propagation"
  incorrect: null
  severity: null
  difficulty: medium
  tags: [false_positive, transaction, baseline]
  misleading_points: "None - correct transaction handling"

- id: FP_003
  category: false_positive
  axis: false_positive
  name: correct_authorization_check
  plan: "Proper authorization with @PreAuthorize"
  bug_description: null
  correct: "@PreAuthorize with proper SpEL expression"
  incorrect: null
  severity: null
  difficulty: medium
  tags: [false_positive, authorization, baseline]
  misleading_points: "None - proper security implementation"

- id: FP_004
  category: false_positive
  axis: false_positive
  name: correct_state_machine
  plan: "Proper state transition validation"
  bug_description: null
  correct: "State machine with proper transition validation"
  incorrect: null
  severity: null
  difficulty: medium
  tags: [false_positive, state, baseline]
  misleading_points: "None - proper state management"

- id: FP_005
  category: false_positive
  axis: false_positive
  name: correct_bigdecimal_usage
  plan: "Proper BigDecimal for monetary calculations"
  bug_description: null
  correct: "BigDecimal with proper scale and rounding"
  incorrect: null
  severity: null
  difficulty: easy
  tags: [false_positive, calculation, baseline]
  misleading_points: "None - proper decimal handling"

- id: FP_006
  category: false_positive
  axis: false_positive
  name: complex_nested_transaction
  plan: "Properly nested transactions"
  bug_description: null
  correct: "@Transactional(propagation = Propagation.REQUIRES_NEW) correctly used"
  incorrect: null
  severity: null
  difficulty: medium
  tags: [false_positive, transaction, complex]
  misleading_points: "Nested transactions look suspicious but are correct"

- id: FP_007
  category: false_positive
  axis: false_positive
  name: complex_state_machine
  plan: "Complete state machine implementation"
  bug_description: null
  correct: "All transitions validated with proper enum state machine"
  incorrect: null
  severity: null
  difficulty: medium
  tags: [false_positive, state, complex]
  misleading_points: "Complex state logic but all paths valid"

- id: FP_008
  category: false_positive
  axis: false_positive
  name: intentional_no_validation
  plan: "Admin bypass for testing"
  bug_description: null
  correct: "Intentional skip validation for admin override"
  incorrect: null
  severity: null
  difficulty: medium
  tags: [false_positive, validation, intentional]
  misleading_points: "Looks like missing validation but intentional"

- id: FP_009
  category: false_positive
  axis: false_positive
  name: intentional_raw_sql
  plan: "Performance-critical raw SQL"
  bug_description: null
  correct: "@Query with nativeQuery and proper parameter binding"
  incorrect: null
  severity: null
  difficulty: medium
  tags: [false_positive, sql, intentional]
  misleading_points: "Raw SQL looks dangerous but is properly sanitized"

- id: FP_010
  category: false_positive
  axis: false_positive
  name: intentional_modifying_query
  plan: "Bulk update without entity listeners"
  bug_description: null
  correct: "@Modifying @Query for performance - listeners not needed"
  incorrect: null
  severity: null
  difficulty: medium
  tags: [false_positive, modifying, intentional]
  misleading_points: "@Modifying looks wrong but listeners not needed here"

- id: FP_011
  category: false_positive
  axis: false_positive
  name: intentional_no_index
  plan: "Low cardinality column without index"
  bug_description: null
  correct: "Index would hurt more than help for this column"
  incorrect: null
  severity: null
  difficulty: medium
  tags: [false_positive, index, intentional]
  misleading_points: "Missing index is intentional decision"

- id: FP_012
  category: false_positive
  axis: false_positive
  name: optimized_counter_cache
  plan: "Denormalized count field for performance"
  bug_description: null
  correct: "@Formula or dedicated count field with proper sync"
  incorrect: null
  severity: null
  difficulty: hard
  tags: [false_positive, optimization, denormalization]
  misleading_points: "Denormalization looks wrong but correct pattern"

- id: FP_013
  category: false_positive
  axis: false_positive
  name: optimized_cache_warming
  plan: "Pre-warm cache on startup"
  bug_description: null
  correct: "@PostConstruct cache warming with intentional full load"
  incorrect: null
  severity: null
  difficulty: hard
  tags: [false_positive, optimization, cache]
  misleading_points: "Full table load looks like bug but intentional"

# =============================================================================
# Performance (8 patterns) - Implicit Knowledge
# =============================================================================

- id: PERF_001
  category: performance
  axis: implicit_knowledge
  name: n_plus_one_query
  plan: "Generate order report with product details"
  bug_description: "N+1 query on order items accessing product names - missing JOIN FETCH or @EntityGraph"
  correct: "Use @EntityGraph or JOIN FETCH to eagerly load products with items"
  incorrect: "order.items.forEach { item -> item.product.name }"
  severity: high
  difficulty: easy
  tags: [performance, n_plus_one, jpa, hibernate]

- id: PERF_002
  category: performance
  axis: implicit_knowledge
  name: full_table_load
  plan: "Generate monthly sales report"
  bug_description: "Loading all records into memory - findAll() on potentially millions of records without pagination"
  correct: "Use Pageable with findAll(Pageable) or streaming with @Query"
  incorrect: "orderRepository.findAll()"
  severity: critical
  difficulty: easy
  tags: [performance, memory, pagination, jpa]

- id: PERF_003
  category: performance
  axis: implicit_knowledge
  name: unnecessary_eager_loading
  plan: "Load product catalog"
  bug_description: "FetchType.EAGER on rarely-used associations wastes resources and causes unnecessary joins"
  correct: "Use FetchType.LAZY and fetch explicitly when needed with @EntityGraph"
  incorrect: "fetch = FetchType.EAGER"
  severity: medium
  difficulty: medium
  tags: [performance, eager_loading, jpa, hibernate]

- id: PERF_004
  category: performance
  axis: implicit_knowledge
  name: inefficient_count
  plan: "Get dashboard statistics"
  bug_description: "Loading all records just to count - using list.size instead of repository.count()"
  correct: "Use repository.count() or @Query with COUNT"
  incorrect: "findAll().size"
  severity: high
  difficulty: easy
  tags: [performance, count, jpa]

- id: PERF_005
  category: performance
  axis: implicit_knowledge
  name: index_not_used
  plan: "Search customers by phone number"
  bug_description: "Search condition on non-indexed column causes full table scan"
  correct: "Add index on frequently queried columns or use indexed columns"
  incorrect: "findByPhoneNumber"
  severity: high
  difficulty: medium
  tags: [performance, index, database, query]

- id: PERF_006
  category: performance
  axis: implicit_knowledge
  name: cache_key_collision
  plan: "Cache user profile"
  bug_description: "Same cache key for all users - cache collision causes data leakage between users"
  correct: "@Cacheable(value = [\"userProfile\"], key = \"#userId\")"
  incorrect: "@Cacheable(\"userProfile\")"
  severity: critical
  difficulty: medium
  tags: [performance, cache, security, spring]

- id: PERF_007
  category: performance
  axis: implicit_knowledge
  name: in_memory_aggregation
  plan: "Calculate sales analytics"
  bug_description: "In-memory aggregation and sorting on potentially large datasets instead of using database"
  correct: "Use database-level aggregation with @Query or native SQL"
  incorrect: "findAll().sortedBy { ... }"
  severity: high
  difficulty: medium
  tags: [performance, aggregation, memory, jpa]

- id: PERF_008
  category: performance
  axis: implicit_knowledge
  name: n_plus_one_bulk_operation
  plan: "Update metrics for all active users"
  bug_description: "N+1 queries in bulk operation - creating new service call per iteration in loop"
  correct: "Use batch operations or single query with IN clause"
  incorrect: "users.forEach { user -> userService.updateMetrics(user.id) }"
  severity: high
  difficulty: medium
  tags: [performance, n_plus_one, bulk, batch]

# =============================================================================
# Data Integrity (7 patterns) - Implicit Knowledge
# =============================================================================

- id: DATA_001
  category: data
  axis: implicit_knowledge
  name: no_foreign_key
  plan: "Define order item entity"
  bug_description: "No foreign key constraint - orphan records possible when parent is deleted"
  correct: "Add @OnDelete(action = OnDeleteAction.CASCADE) or handle in service layer"
  incorrect: "@JoinColumn(name = \"order_id\")"
  severity: high
  difficulty: medium
  tags: [data, foreign_key, integrity, jpa]

- id: DATA_002
  category: data
  axis: implicit_knowledge
  name: unique_constraint_missing
  plan: "Define user entity"
  bug_description: "Unique constraint missing - duplicate emails allowed in user registration"
  correct: "@Column(unique = true) or @Table(uniqueConstraints = [UniqueConstraint(...)])"
  incorrect: "var email: String"
  severity: high
  difficulty: easy
  tags: [data, unique, constraint, integrity]

- id: DATA_003
  category: data
  axis: implicit_knowledge
  name: optimistic_lock_missing
  plan: "Define inventory entity"
  bug_description: "No optimistic locking - concurrent updates cause last-write-wins data loss"
  correct: "Add @Version field for optimistic locking"
  incorrect: "data class Inventory("
  severity: high
  difficulty: medium
  tags: [data, concurrency, optimistic_locking, jpa]

- id: DATA_004
  category: data
  axis: implicit_knowledge
  name: soft_delete_leak
  plan: "Search products"
  bug_description: "Deleted records appear in search results - missing @Where clause for soft delete"
  correct: "Add @Where(clause = \"deleted = false\") or @SQLRestriction"
  incorrect: "findByNameContaining"
  severity: medium
  difficulty: medium
  tags: [data, soft_delete, query, jpa]

- id: DATA_005
  category: data
  axis: implicit_knowledge
  name: master_data_not_snapshotted
  plan: "Display order history"
  bug_description: "Product price change affects historical order display - no snapshot of price at order time"
  correct: "Store priceAtPurchase in OrderItem or use temporal tables"
  incorrect: "val productId: Long"
  severity: high
  difficulty: hard
  tags: [data, snapshot, history, integrity]

- id: DATA_006
  category: data
  axis: implicit_knowledge
  name: nullable_column_no_default
  plan: "Add loyalty points feature"
  bug_description: "New column defaults to NULL causing NullPointerException in downstream code"
  correct: "Add @Column(nullable = false) with default value or @ColumnDefault"
  incorrect: "var loyaltyPoints: Int?"
  severity: medium
  difficulty: easy
  tags: [data, null, default, schema]

- id: DATA_007
  category: data
  axis: implicit_knowledge
  name: batch_count_inaccurate
  plan: "Import products from CSV"
  bug_description: "Batch import reports incorrect counts - saveAll skips duplicates but reports full count"
  correct: "Track actual inserts vs skipped duplicates separately"
  incorrect: "return products.size"
  severity: medium
  difficulty: medium
  tags: [data, batch, import, counting]

# =============================================================================
# External Services (7 patterns) - Implicit Knowledge
# =============================================================================

- id: EXT_001
  category: external
  axis: implicit_knowledge
  name: payment_timeout_unhandled
  plan: "Process payment through gateway"
  bug_description: "Payment timeout leaves order in unknown state - no rollback or recovery mechanism"
  correct: "Mark order as PENDING_VERIFICATION and notify admin for manual review"
  incorrect: "catch (e: HttpTimeoutException) { throw PaymentException"
  severity: critical
  difficulty: hard
  tags: [external, payment, timeout, recovery]

- id: EXT_002
  category: external
  axis: implicit_knowledge
  name: webhook_not_idempotent
  plan: "Handle payment webhook"
  bug_description: "Webhook endpoint processes same event multiple times - no idempotency check"
  correct: "Check and store processed event IDs to ensure idempotency"
  incorrect: "fun handlePaymentWebhook"
  severity: high
  difficulty: medium
  tags: [external, webhook, idempotency, duplicate]

- id: EXT_003
  category: external
  axis: implicit_knowledge
  name: api_call_in_transaction
  plan: "Process order with payment"
  bug_description: "External API call inside @Transactional - payment charged even if transaction rolls back"
  correct: "Move external API call outside transaction or use saga pattern"
  incorrect: "@Transactional"
  severity: critical
  difficulty: hard
  tags: [external, transaction, api, rollback]

- id: EXT_004
  category: external
  axis: implicit_knowledge
  name: retry_without_idempotency
  plan: "Submit order for fulfillment"
  bug_description: "Network retry creates duplicate orders - no idempotency key for retries"
  correct: "Use idempotency key to prevent duplicate operations on retry"
  incorrect: "@Retryable"
  severity: high
  difficulty: medium
  tags: [external, retry, idempotency, duplicate]

- id: EXT_005
  category: external
  axis: implicit_knowledge
  name: inventory_sync_race_condition
  plan: "Sync inventory from warehouse"
  bug_description: "Async inventory sync race condition - order placed during sync gets stale stock data"
  correct: "Use optimistic locking or queue-based sync with proper ordering"
  incorrect: "@Async"
  severity: high
  difficulty: hard
  tags: [external, async, inventory, race_condition]

- id: EXT_006
  category: external
  axis: implicit_knowledge
  name: error_swallowed
  plan: "Generate shipping label"
  bug_description: "Shipping API error swallowed in empty catch block - failure treated as success"
  correct: "Log error, set appropriate status, and notify for manual handling"
  incorrect: "catch (e: Exception) { }"
  severity: high
  difficulty: easy
  tags: [external, error_handling, shipping, silent_failure]

- id: EXT_007
  category: external
  axis: implicit_knowledge
  name: path_traversal_vulnerability
  plan: "Export report to file"
  bug_description: "Path traversal vulnerability - unsanitized user input used in file path construction"
  correct: "Validate and sanitize filename, use Path.normalize() and check within allowed directory"
  incorrect: "File(reportsDirectory, filename)"
  severity: critical
  difficulty: medium
  tags: [security, path_traversal, injection, file]
