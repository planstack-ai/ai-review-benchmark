# AI Code Review Benchmark - Spring Boot (Kotlin) Bug Pattern Definitions
# 30 MVP patterns (25 bugs + 5 false positives) for Spring Boot e-commerce order processing
# Version: 1.0
# Framework: Spring Boot 3.2+, Kotlin 1.9+

# =============================================================================
# Price Calculation (6 patterns) - Spec Alignment
# =============================================================================

- id: CALC_001
  category: calculation
  axis: spec_alignment
  name: discount_rate_direction
  plan: "Apply 10% discount for members"
  bug_description: "Discount rate direction wrong, becomes 90% off"
  correct: "total.multiply(BigDecimal(\"0.9\"))"
  incorrect: "total.multiply(BigDecimal(\"0.1\"))"
  severity: critical
  difficulty: easy
  tags: [calculation, discount, member]

- id: CALC_002
  category: calculation
  axis: spec_alignment
  name: tax_calculation_order
  plan: "Calculate total with 10% tax after discount"
  bug_description: "Tax calculation order wrong - applying tax before discount yields different amount"
  correct: "subtotal.subtract(discount).multiply(BigDecimal(\"1.1\"))"
  incorrect: "subtotal.multiply(BigDecimal(\"1.1\")).subtract(discount)"
  severity: high
  difficulty: medium
  tags: [calculation, tax, discount]

- id: CALC_003
  category: calculation
  axis: spec_alignment
  name: floating_point_currency
  plan: "Calculate price with decimal precision"
  bug_description: "Using Double instead of BigDecimal for monetary calculations"
  correct: "BigDecimal(\"0.1\") + BigDecimal(\"0.2\")"
  incorrect: "0.1 + 0.2"
  severity: high
  difficulty: medium
  tags: [calculation, currency, precision]

- id: CALC_004
  category: calculation
  axis: spec_alignment
  name: inconsistent_rounding
  plan: "Calculate order total with consistent rounding"
  bug_description: "Inconsistent rounding - round per item then sum vs sum then round yields different results"
  correct: "items.map { it.subtotal }.reduce(BigDecimal::add).setScale(2, RoundingMode.HALF_UP)"
  incorrect: "items.map { it.subtotal.setScale(2, RoundingMode.HALF_UP) }.reduce(BigDecimal::add)"
  severity: medium
  difficulty: medium
  tags: [calculation, rounding]

- id: CALC_005
  category: calculation
  axis: spec_alignment
  name: hardcoded_tax_rate
  plan: "Apply current tax rate (10%)"
  bug_description: "Hardcoded old tax rate - still using 8% instead of 10%"
  correct: "subtotal.multiply(taxRateRepository.findCurrentRate())"
  incorrect: "subtotal.multiply(BigDecimal(\"0.08\"))"
  severity: high
  difficulty: easy
  tags: [calculation, tax, hardcode]

- id: CALC_006
  category: calculation
  axis: spec_alignment
  name: free_shipping_boundary
  plan: "Free shipping for orders of 5000 yen or more"
  bug_description: "Boundary condition error - >= 5000 vs > 5000"
  correct: "if (total >= BigDecimal(\"5000\")) BigDecimal.ZERO else shippingFee"
  incorrect: "if (total > BigDecimal(\"5000\")) BigDecimal.ZERO else shippingFee"
  severity: medium
  difficulty: easy
  tags: [calculation, shipping, boundary]

# =============================================================================
# User & Authorization (4 patterns) - Spec Alignment
# =============================================================================

- id: AUTH_001
  category: authorization
  axis: spec_alignment
  name: access_other_user_order
  plan: "Users can only view their own orders"
  bug_description: "IDOR vulnerability - can access other user's order by changing ID"
  correct: "orderRepository.findByIdAndUserId(orderId, currentUser.id)"
  incorrect: "orderRepository.findById(orderId)"
  severity: critical
  difficulty: easy
  tags: [authorization, idor, security]

- id: AUTH_002
  category: authorization
  axis: spec_alignment
  name: manipulate_other_cart
  plan: "Users can only modify their own cart"
  bug_description: "Can manipulate other user's cart by specifying cart_id"
  correct: "cartRepository.findByUserId(currentUser.id)"
  incorrect: "cartRepository.findById(cartId)"
  severity: critical
  difficulty: easy
  tags: [authorization, cart, security]

- id: AUTH_003
  category: authorization
  axis: spec_alignment
  name: preauthorize_condition_wrong
  plan: "Only order owner or admin can cancel order"
  bug_description: "@PreAuthorize condition uses OR instead of proper ownership check"
  correct: "@PreAuthorize(\"@orderService.isOwner(#orderId, principal) or hasRole('ADMIN')\")"
  incorrect: "@PreAuthorize(\"hasRole('USER') or hasRole('ADMIN')\")"
  severity: critical
  difficulty: medium
  tags: [authorization, preauthorize, security]

- id: AUTH_004
  category: authorization
  axis: spec_alignment
  name: admin_permission_missing
  plan: "Only admins can modify product prices"
  bug_description: "Regular users can change prices - admin check missing"
  correct: "@PreAuthorize(\"hasRole('ADMIN')\")"
  incorrect: "// no permission check"
  severity: critical
  difficulty: easy
  tags: [authorization, admin, permission]

# =============================================================================
# State Management (4 patterns) - Spec Alignment
# =============================================================================

- id: STATE_001
  category: state
  axis: spec_alignment
  name: invalid_state_transition
  plan: "Order can only be cancelled from PENDING or CONFIRMED state"
  bug_description: "Allows cancellation from any state including SHIPPED"
  correct: "if (order.status == PENDING || order.status == CONFIRMED) { order.cancel() }"
  incorrect: "order.cancel()"
  severity: high
  difficulty: medium
  tags: [state, validation, order]

- id: STATE_002
  category: state
  axis: spec_alignment
  name: state_update_conflict
  plan: "Prevent concurrent state updates"
  bug_description: "Race condition - no optimistic locking on state update"
  correct: "@Version var version: Long = 0"
  incorrect: "// no version field"
  severity: high
  difficulty: hard
  tags: [state, concurrency, locking]

- id: STATE_003
  category: state
  axis: spec_alignment
  name: check_then_act_race
  plan: "Atomic check and update for stock reservation"
  bug_description: "Check-then-act race condition between stock check and reservation"
  correct: "stockRepository.decrementIfAvailable(productId, quantity)"
  incorrect: "if (stock.quantity >= quantity) { stock.quantity = stock.quantity - quantity }"
  severity: critical
  difficulty: hard
  tags: [state, concurrency, stock]

- id: STATE_004
  category: state
  axis: spec_alignment
  name: enum_comparison_wrong
  plan: "Check if order is in completed states"
  bug_description: "Using string comparison instead of enum comparison"
  correct: "order.status in completedStatuses"
  incorrect: "completedStatuses.any { it.name == order.status.name }"
  severity: medium
  difficulty: medium
  tags: [state, enum, comparison]

# =============================================================================
# Time & Date (3 patterns) - Spec Alignment
# =============================================================================

- id: TIME_001
  category: time
  axis: spec_alignment
  name: timezone_not_considered
  plan: "Check if campaign is active based on Japan time"
  bug_description: "Using system default timezone instead of specified timezone"
  correct: "LocalDateTime.now(ZoneId.of(\"Asia/Tokyo\"))"
  incorrect: "LocalDateTime.now()"
  severity: high
  difficulty: medium
  tags: [time, timezone, campaign]

- id: TIME_002
  category: time
  axis: spec_alignment
  name: date_boundary_error
  plan: "Campaign valid until end of specified date"
  bug_description: "End date comparison excludes the last day"
  correct: "!now.isAfter(campaign.endDate.atTime(23, 59, 59))"
  incorrect: "now.isBefore(campaign.endDate.atStartOfDay())"
  severity: medium
  difficulty: medium
  tags: [time, boundary, campaign]

- id: TIME_003
  category: time
  axis: spec_alignment
  name: campaign_period_check
  plan: "Apply campaign discount only during valid period"
  bug_description: "Only checking start date, not end date"
  correct: "now.isAfter(campaign.startDate) && now.isBefore(campaign.endDate)"
  incorrect: "now.isAfter(campaign.startDate)"
  severity: high
  difficulty: easy
  tags: [time, campaign, validation]

# =============================================================================
# Inventory Management (2 patterns) - Spec Alignment
# =============================================================================

- id: STOCK_001
  category: stock
  axis: spec_alignment
  name: stock_reservation_race
  plan: "Reserve stock atomically"
  bug_description: "Race condition between stock check and decrement"
  correct: "@Modifying @Query(\"UPDATE Stock s SET s.quantity = s.quantity - :qty WHERE s.productId = :productId AND s.quantity >= :qty\")"
  incorrect: "if (stock.quantity >= qty) stock.quantity = stock.quantity - qty"
  severity: critical
  difficulty: hard
  tags: [stock, concurrency, atomic]

- id: STOCK_002
  category: stock
  axis: spec_alignment
  name: negative_stock_allowed
  plan: "Stock quantity must not go negative"
  bug_description: "No validation prevents negative stock"
  correct: "@field:Min(0) var quantity: Int"
  incorrect: "var quantity: Int"
  severity: high
  difficulty: easy
  tags: [stock, validation, constraint]

# =============================================================================
# Notification (1 pattern) - Spec Alignment
# =============================================================================

- id: NOTIFY_001
  category: notification
  axis: spec_alignment
  name: async_notification_failure
  plan: "Send order confirmation email asynchronously"
  bug_description: "Async email failure silently ignored - no error handling"
  correct: "@Async fun sendEmail(): CompletableFuture<Unit> { try { ... } catch (e: Exception) { logger.error(...); throw e } }"
  incorrect: "@Async fun sendEmail() { ... }"
  severity: medium
  difficulty: medium
  tags: [notification, async, error_handling]

# =============================================================================
# Spring Boot Specific (5 patterns) - Implicit Knowledge
# =============================================================================

- id: SPRING_001
  category: spring
  axis: implicit_knowledge
  name: transactional_propagation_wrong
  plan: "Order and payment must be processed atomically"
  bug_description: "@Transactional propagation issue - nested service has REQUIRES_NEW causing partial commit"
  correct: "@Transactional(propagation = Propagation.REQUIRED)"
  incorrect: "@Transactional // nested call has REQUIRES_NEW"
  severity: critical
  difficulty: hard
  tags: [spring, transaction, propagation]

- id: SPRING_002
  category: spring
  axis: implicit_knowledge
  name: async_without_enable
  plan: "Process order asynchronously"
  bug_description: "@Async annotation ignored - @EnableAsync missing on configuration"
  correct: "@EnableAsync @Configuration class AsyncConfig"
  incorrect: "// @EnableAsync missing"
  severity: high
  difficulty: medium
  tags: [spring, async, configuration]

- id: SPRING_003
  category: spring
  axis: implicit_knowledge
  name: field_injection_testing
  plan: "Inject OrderService dependency"
  bug_description: "Field injection makes unit testing difficult - use constructor injection"
  correct: "@Service class OrderController(private val orderService: OrderService)"
  incorrect: "@Service class OrderController { @Autowired lateinit var orderService: OrderService }"
  severity: medium
  difficulty: easy
  tags: [spring, injection, testing]

- id: SPRING_004
  category: spring
  axis: implicit_knowledge
  name: missing_valid_annotation
  plan: "Validate request body"
  bug_description: "@Valid missing on @RequestBody - validation annotations ignored"
  correct: "fun create(@Valid @RequestBody request: OrderRequest): ResponseEntity<*>"
  incorrect: "fun create(@RequestBody request: OrderRequest): ResponseEntity<*>"
  severity: high
  difficulty: easy
  tags: [spring, validation, request]

- id: SPRING_005
  category: spring
  axis: implicit_knowledge
  name: exception_info_leak
  plan: "Handle exceptions gracefully"
  bug_description: "Exception message exposed to client - potential security info leak"
  correct: "ResponseEntity.badRequest().body(ErrorResponse(\"Invalid request\"))"
  incorrect: "ResponseEntity.badRequest().body(e.message)"
  severity: high
  difficulty: medium
  tags: [spring, security, exception]

# =============================================================================
# False Positive (5 patterns)
# =============================================================================

- id: FP_001
  category: false_positive
  axis: false_positive
  name: correct_discount_calculation
  plan: "Apply 10% member discount correctly"
  bug_description: null
  correct: "total.multiply(BigDecimal(\"0.9\"))"
  incorrect: null
  severity: null
  difficulty: easy
  tags: [false_positive, calculation, baseline]
  misleading_points: "None - standard implementation"

- id: FP_002
  category: false_positive
  axis: false_positive
  name: correct_transactional_usage
  plan: "Proper transactional boundary"
  bug_description: null
  correct: "@Transactional with proper propagation"
  incorrect: null
  severity: null
  difficulty: medium
  tags: [false_positive, transaction, baseline]
  misleading_points: "None - correct transaction handling"

- id: FP_003
  category: false_positive
  axis: false_positive
  name: correct_authorization_check
  plan: "Proper authorization with @PreAuthorize"
  bug_description: null
  correct: "@PreAuthorize with proper SpEL expression"
  incorrect: null
  severity: null
  difficulty: medium
  tags: [false_positive, authorization, baseline]
  misleading_points: "None - proper security implementation"

- id: FP_004
  category: false_positive
  axis: false_positive
  name: correct_state_machine
  plan: "Proper state transition validation"
  bug_description: null
  correct: "State machine with proper transition validation"
  incorrect: null
  severity: null
  difficulty: medium
  tags: [false_positive, state, baseline]
  misleading_points: "None - proper state management"

- id: FP_005
  category: false_positive
  axis: false_positive
  name: correct_bigdecimal_usage
  plan: "Proper BigDecimal for monetary calculations"
  bug_description: null
  correct: "BigDecimal with proper scale and rounding"
  incorrect: null
  severity: null
  difficulty: easy
  tags: [false_positive, calculation, baseline]
  misleading_points: "None - proper decimal handling"
